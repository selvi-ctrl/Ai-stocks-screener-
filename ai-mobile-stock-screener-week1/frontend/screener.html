<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener - AI Stock Screener</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="bg-animation"></div>
    
    <nav class="navbar">
        <div class="navbar-brand">AI Stock Screener</div>
        <ul class="navbar-menu">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="screener.html">Stock Screener</a></li>
            <li><button class="theme-toggle" id="themeToggle">üåó Theme</button></li>
            <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>AI-Powered Stock Screener ü§ñ</h1>
            <p style="color: var(--text-secondary);">Use natural language to find the perfect stocks</p>
        </div>

        <div class="screener-container">
            <h2 style="margin-bottom: 1.5rem;">Search Stocks with AI</h2>
            
            <div class="search-box">
                <input type="text" id="queryInput" class="form-control" 
                       placeholder="Example: Show me tech stocks with PE ratio less than 20 and revenue growth above 15%">
                <button class="btn btn-primary" id="searchBtn" style="width: auto; padding: 0.875rem 2rem;">
                    üîç Search
                </button>
            </div>

            <div id="alert" class="alert"></div>
            <div class="spinner" id="spinner"></div>

            <div style="margin:1.25rem 0 0.5rem 0; display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
                <div>
                    <h3 style="margin:0; color: var(--text-secondary); font-size:0.95rem;">LIVE MARKET TICKER</h3>
                    <p style="margin:0; color: var(--text-secondary); font-size:0.85rem;">Auto-refreshing with Binance quotes</p>
                </div>
                <div style="display:flex; align-items:center; gap:0.5rem; color: var(--text-secondary); font-size:0.9rem;">
                    <label for="refreshSelect">Refresh</label>
                    <select id="refreshSelect" class="form-control" style="width:160px; padding:0.45rem 0.75rem;">
                        <option value="3000">3s</option>
                        <option value="5000" selected>5s</option>
                        <option value="10000">10s</option>
                        <option value="15000">15s</option>
                    </select>
                </div>
            </div>
            <div id="liveTicker" class="live-ticker"></div>

            <div style="margin: 2rem 0;">
                <h3 style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.95rem;">
                    POPULAR SEARCHES:
                </h3>
                <div class="filters-grid">
                    <button class="btn btn-secondary" onclick="runQuery('high dividend yield stocks in IT sector')">
                        üí∞ High Dividend IT
                    </button>
                    <button class="btn btn-secondary" onclick="runQuery('tech stocks with PE under 30')">
                        üíª Low PE Tech
                    </button>
                    <button class="btn btn-secondary" onclick="runQuery('growth stocks with strong revenue')">
                        üìà Growth Stocks
                    </button>
                    <button class="btn btn-secondary" onclick="runQuery('value stocks with low debt to equity')">
                        üíé Value Stocks
                    </button>
                    <button class="btn btn-secondary" onclick="runQuery('stocks with market cap over 1000 crore')">
                        üè¢ Large Cap
                    </button>
                    <button class="btn btn-secondary" onclick="runQuery('profitable companies with positive cash flow')">
                        üíµ Profitable
                    </button>
                </div>
            </div>

            <div id="results" class="stock-list"></div>
        </div>

        <div class="screener-container">
            <h2 style="margin-bottom: 1.5rem;">Advanced Filters</h2>
            
            <div class="filters-grid">
                <div class="form-group">
                    <label>Sector</label>
                    <select class="form-control" id="sectorFilter">
                        <option value="">All Sectors</option>
                        <option value="IT">Information Technology</option>
                        <option value="Finance">Finance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Energy">Energy</option>
                        <option value="Consumer">Consumer Goods</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Market Cap</label>
                    <select class="form-control" id="marketCapFilter">
                        <option value="">All Caps</option>
                        <option value="large">Large Cap (>10,000 Cr)</option>
                        <option value="mid">Mid Cap (2,000-10,000 Cr)</option>
                        <option value="small">Small Cap (<2,000 Cr)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>PE Ratio</label>
                    <input type="number" class="form-control" id="peFilter" placeholder="Max PE Ratio">
                </div>

                <div class="form-group">
                    <label>Dividend Yield (%)</label>
                    <input type="number" class="form-control" id="dividendFilter" placeholder="Min Dividend %">
                </div>
            </div>

            <button class="btn btn-primary" onclick="applyFilters()" style="width: 200px; margin-top: 1rem;">
                Apply Filters
            </button>
        </div>
    </div>

    <script>
        // Auth check
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') document.body.classList.add('light');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        });

        // Search functionality
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const alert = document.getElementById('alert');
        const spinner = document.getElementById('spinner');
        const results = document.getElementById('results');
        const liveTicker = document.getElementById('liveTicker');
        const refreshSelect = document.getElementById('refreshSelect');
        let liveSymbols = [];
        let refreshHandle = null;
        let lastMeta = null;

        function showAlert(message, type) {
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.className = 'alert';
            }, 5000);
        }

        async function runQuery(query) {
            queryInput.value = query;
            await searchStocks();
        }

        async function searchStocks() {
            const query = queryInput.value.trim();
            
            if (!query) {
                showAlert('Please enter a search query', 'error');
                return;
            }

            spinner.classList.add('show');
            results.innerHTML = '';

            try {
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ query }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`Found matching stocks for: "${query}"`, 'success');
                    const rows = data.data || [];
                    lastMeta = data.meta || null;

                    const header = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3 style="color: var(--text-secondary);">Showing ${rows.length} result(s)</h3>
                            ${lastMeta ? `<span style="color: var(--text-secondary); font-size:0.9rem;">${lastMeta.cache ? 'Cached' : 'Live'} ‚Ä¢ ${lastMeta.executionMs || 0}ms</span>` : ''}
                        </div>
                    `;

                    const table = rows.length === 0
                        ? '<p style="color: var(--text-secondary);">No matches found.</p>'
                        : `
                            <div style="overflow-x:auto;">
                                <table style="width:100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Symbol</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Name</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Sector</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">PE</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Promoter %</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Earnings</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">Quarter</th>
                                            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid var(--border-color);">MCap</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rows.map(r => `
                                            <tr>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color); font-weight:600;">${r.symbol}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.name || ''}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color); color: var(--text-secondary);">${r.sector || ''}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.pe_ratio ?? '‚Äî'}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.promoter_holding ?? '‚Äî'}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.earnings ? 'Positive' : 'Negative'}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.quarter || ''}</td>
                                                <td style="padding:0.5rem; border-bottom:1px solid var(--border-color);">${r.market_cap ?? '‚Äî'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;

                    const debug = `
                        <div style="margin-top:1rem; padding:1rem; border:1px solid var(--border-color); border-radius:0.75rem; background: rgba(15,23,42,0.4);">
                            <p style="color: var(--text-secondary); margin-bottom:0.5rem;">DSL</p>
                            <pre style="white-space:pre-wrap; color: var(--text-primary);">${JSON.stringify(data.dsl || {}, null, 2)}</pre>
                            <p style="color: var(--text-secondary); margin-top:1rem; margin-bottom:0.5rem;">SQL</p>
                            <pre style="white-space:pre-wrap; color: var(--text-primary);">${data.sql || ''}</pre>
                        </div>
                    `;

                    results.innerHTML = header + table + debug;
                } else {
                    const msg = data?.error || 'Search failed. Please try again.';
                    showAlert(msg, 'error');
                    results.innerHTML = '';
                }
            } catch (error) {
                showAlert('Network error. Please check your connection.', 'error');
            } finally {
                spinner.classList.remove('show');
            }
        }

        function applyFilters() {
            const sector = document.getElementById('sectorFilter').value;
            const marketCap = document.getElementById('marketCapFilter').value;
            const pe = document.getElementById('peFilter').value;
            const dividend = document.getElementById('dividendFilter').value;

            let query = 'Show me stocks';
            if (sector) query += ` in ${sector} sector`;
            if (marketCap) query += ` with ${marketCap} market cap`;
            if (pe) query += ` and PE ratio less than ${pe}`;
            if (dividend) query += ` and dividend yield above ${dividend}%`;

            queryInput.value = query;
            searchStocks();
        }

        searchBtn.addEventListener('click', searchStocks);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchStocks();
            }
        });

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const payload = await res.json();
                if (payload?.data) {
                    liveSymbols = payload.data.defaultSymbols || [];
                    refreshSelect.value = String(payload.data.liveRefreshMs || 5000);
                }
            } catch (e) {
                liveSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
            }

            const storedSymbols = localStorage.getItem('liveSymbols');
            const storedInterval = localStorage.getItem('liveInterval');
            if (storedSymbols) liveSymbols = storedSymbols.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            if (storedInterval) refreshSelect.value = storedInterval;

            startLiveTicker();
        }

        async function fetchLiveQuotes() {
            if (!liveSymbols.length) return;
            try {
                const url = `/api/stocks/quotes?symbols=${liveSymbols.join(',')}`;
                const res = await fetch(url);
                const payload = await res.json();
                if (!payload?.data) return;
                liveTicker.innerHTML = payload.data.map((q) => {
                    const change = Number(q.changePercent || 0);
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    return `
                        <div class="live-tile">
                            <div class="live-symbol">${q.symbol}</div>
                            <div class="live-price">${Number(q.price).toFixed(4)}</div>
                            <div class="live-change ${changeClass}">${change.toFixed(2)}%</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Live ticker error', err);
            }
        }

        function startLiveTicker() {
            if (refreshHandle) clearInterval(refreshHandle);
            fetchLiveQuotes();
            const ms = Number(refreshSelect.value) || 5000;
            refreshHandle = setInterval(fetchLiveQuotes, ms);
        }

        refreshSelect.addEventListener('change', () => {
            startLiveTicker();
        });

        loadSettings();
    </script>
</body>
</html>
