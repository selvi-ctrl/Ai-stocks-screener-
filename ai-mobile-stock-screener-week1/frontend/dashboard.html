<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Stock Screener</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="bg-animation"></div>
    
    <nav class="navbar">
        <div class="navbar-brand">AI Stock Screener</div>
        <ul class="navbar-menu">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="screener.html">Stock Screener</a></li>
            <li><button class="theme-toggle" id="themeToggle">ðŸŒ— Theme</button></li>
            <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Welcome, <span id="userName">User</span>! ðŸ‘‹</h1>
            <p style="color: var(--text-secondary);">Here's your investment overview</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-icon">ðŸ’¼</span>
                </div>
                <div class="stat-card-value">$0</div>
                <div class="stat-card-label">Portfolio Value</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-icon">ðŸ“ˆ</span>
                </div>
                <div class="stat-card-value">0</div>
                <div class="stat-card-label">Stocks Tracked</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-icon">ðŸ””</span>
                </div>
                <div class="stat-card-value">0</div>
                <div class="stat-card-label">Active Alerts</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-icon">âš¡</span>
                </div>
                <div class="stat-card-value" style="color: var(--success-color);">+0%</div>
                <div class="stat-card-label">Today's Change</div>
            </div>
        </div>

        <div class="screener-container">
            <h2 style="margin-bottom: 1.5rem;">Quick Stock Screener</h2>
            
            <div class="search-box">
                <input type="text" id="queryInput" class="form-control" 
                       placeholder="Try: Show me tech stocks with PE ratio less than 20">
                <button class="btn btn-primary" id="searchBtn" style="width: auto; padding: 0.875rem 2rem;">
                    Search
                </button>
            </div>

            <div id="alert" class="alert"></div>
            <div class="spinner" id="spinner"></div>

            <div id="results" class="stock-list"></div>
        </div>

        <div class="screener-container">
            <h2 style="margin-bottom: 1.5rem;">Settings & Live Controls</h2>
            <div class="filters-grid">
                <div class="form-group">
                    <label for="liveSymbols">Live symbols (comma separated)</label>
                    <input type="text" id="liveSymbols" class="form-control" placeholder="BTCUSDT,ETHUSDT,BNBUSDT">
                </div>
                <div class="form-group">
                    <label for="liveInterval">Live refresh (ms)</label>
                    <input type="number" id="liveInterval" class="form-control" min="2000" step="1000" value="5000">
                </div>
                <div class="form-group">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect" class="form-control">
                        <option value="dark">Aurora Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" style="width:200px; margin-top:1rem;" id="saveSettings">Save Settings</button>
            <p style="margin-top:0.75rem; color: var(--text-secondary); font-size:0.9rem;">Settings persist locally and update the live ticker on the screener page.</p>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Decode JWT to get user info (simple decoding, not validation)
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        const userInfo = parseJwt(token);
        if (userInfo && userInfo.email) {
            document.getElementById('userName').textContent = userInfo.email.split('@')[0];
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeSelect = document.getElementById('themeSelect');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') document.body.classList.add('light');
        themeSelect.value = savedTheme;
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light');
            const t = document.body.classList.contains('light') ? 'light' : 'dark';
            localStorage.setItem('theme', t);
            themeSelect.value = t;
        });

        // Search functionality
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const alert = document.getElementById('alert');
        const spinner = document.getElementById('spinner');
        const results = document.getElementById('results');
        const liveSymbolsInput = document.getElementById('liveSymbols');
        const liveIntervalInput = document.getElementById('liveInterval');
        const saveSettingsBtn = document.getElementById('saveSettings');

        function showAlert(message, type) {
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.className = 'alert';
            }, 5000);
        }

        async function runQuery(query) {
            queryInput.value = query;
            await searchStocks();
        }

        async function searchStocks() {
            const query = queryInput.value.trim();
            
            if (!query) {
                showAlert('Please enter a search query', 'error');
                return;
            }

            spinner.classList.add('show');
            results.innerHTML = '';

            try {
                const response = await fetch('/api/parse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ query }),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert(`Query processed: "${query}"`, 'success');
                    const rows = data.data || [];
                    results.innerHTML = rows.length === 0
                        ? '<p style="color: var(--text-secondary);">No matches found.</p>'
                        : rows.map(stock => `
                            <div class="stock-item">
                                <div class="stock-info">
                                    <h3>${stock.symbol}</h3>
                                    <p>${stock.name || ''}</p>
                                    <p style="color: var(--primary-color);">${stock.sector || ''}</p>
                                </div>
                                <div class="stock-price">
                                    <div class="price">${stock.market_cap ? stock.market_cap : ''}</div>
                                    <div class="change ${stock.earnings ? 'positive' : 'negative'}">
                                        ${stock.earnings ? 'Earnings Positive' : 'Earnings Negative'}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                } else {
                    showAlert('Search failed. Please try again.', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please check your connection.', 'error');
            } finally {
                spinner.classList.remove('show');
            }
        }

        searchBtn.addEventListener('click', searchStocks);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchStocks();
            }
        });

        // Load settings from backend/local
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const payload = await res.json();
                if (payload?.data) {
                    liveSymbolsInput.value = (payload.data.defaultSymbols || []).join(',');
                    liveIntervalInput.value = payload.data.liveRefreshMs || 5000;
                }
            } catch (e) {
                liveSymbolsInput.value = 'BTCUSDT,ETHUSDT,BNBUSDT';
            }
            const storedSymbols = localStorage.getItem('liveSymbols');
            const storedInterval = localStorage.getItem('liveInterval');
            if (storedSymbols) liveSymbolsInput.value = storedSymbols;
            if (storedInterval) liveIntervalInput.value = storedInterval;
        }

        saveSettingsBtn.addEventListener('click', () => {
            localStorage.setItem('liveSymbols', liveSymbolsInput.value.trim());
            localStorage.setItem('liveInterval', liveIntervalInput.value.trim());
            localStorage.setItem('theme', themeSelect.value);
            if (themeSelect.value === 'light') {
                document.body.classList.add('light');
            } else {
                document.body.classList.remove('light');
            }
            showAlert('Settings saved. Live ticker will use these values.', 'success');
        });

        loadSettings();
    </script>
</body>
</html>
